/*!
 * cropular
 * https://github.com/mattmcardle/cropper#readme
 * Version: 0.0.1 - 2016-02-17T19:19:46.630Z
 * License: ISC
 */
!function(){"use strict";var e=angular.module("cropular",[]);e.controller("CropularController",["$scope","$element","$timeout","$filter","$http","$q",function(e,t,r,c,a,o){var s=this;s.canvas=document.getElementById("canvas"),s.image=document.getElementById("attachment-image"),console.log(e),s.url=e.imageUrl,s.cropObject=e.cropObject,s.enableCrop=e.enableCrop,s.test=e.test,s.rect={},s.mouseX=0,s.mouseY=0,s.closeEnough=10,s.dragTL=!1,s.dragBL=!1,s.dragTR=!1,s.dragBR=!1,s.canvasStyle={},console.log("here"),t.find("img").bind("load",function(){s.calculateSize(),s.crop()}),s.saveCrop=function(){e.cropObject={width:s.rect.w,height:s.rect.h,x:s.rect.startX,y:s.rect.startY,clientImageWidth:s.canvas.width,clientImageHeight:s.canvas.height},console.log(e.cropObject)},s.getImage=function(){var e=o.defer();return a.get(s.url).success(function(t){e.resolve(t)}.bind(e)),e.promise},s.loadImage=function(){s.getImage().then(function(){s.calculateSize(),s.crop()}.bind(s))},s.calculateSize=function(){s.canvas.width=s.image.clientWidth,s.canvas.height=s.image.clientHeight,s.canvasStyle={"background-image":"url("+e.imageUrl+")","background-size":"contain"}},s.crop=function(){s.ctx=s.canvas.getContext("2d"),s.showCropControls=!0,s.editOptions=!1,s.canvas.addEventListener("mousedown",s.mouseDown,!1),s.canvas.addEventListener("mouseup",s.mouseUp,!1),s.canvas.addEventListener("mousemove",s.mouseMove,!1),s.rect={startX:s.image.clientWidth/4,startY:s.image.clientHeight/4,w:s.image.clientWidth/2,h:s.image.clientHeight/2},s.draw(),s.saveCrop()},s.mouseDown=function(e){var t=s.getPageTopLeft(s.canvas);if(s.mouseX=e.pageX-t.left,s.mouseY=e.pageY-t.top,void 0===s.rect.w)s.rect.startX=s.mouseY,s.rect.startY=s.mouseX,s.dragBR=!0;else if(s.checkCloseEnough(s.mouseX,s.rect.startX)&&s.checkCloseEnough(s.mouseY,s.rect.startY))s.dragTL=!0;else if(s.checkCloseEnough(s.mouseX,s.rect.startX+s.rect.w)&&s.checkCloseEnough(s.mouseY,s.rect.startY))s.dragTR=!0;else if(s.checkCloseEnough(s.mouseX,s.rect.startX)&&s.checkCloseEnough(s.mouseY,s.rect.startY+s.rect.h))s.dragBL=!0;else{if(!s.checkCloseEnough(s.mouseX,s.rect.startX+s.rect.w)||!s.checkCloseEnough(s.mouseY,s.rect.startY+s.rect.h))return;s.dragBR=!0}s.ctx.clearRect(0,0,s.canvas.width,s.canvas.height),s.draw()},s.checkCloseEnough=function(e,t){return Math.abs(e-t)<s.closeEnough},s.mouseUp=function(){(s.dragTL||s.dragTR||s.dragBL||s.dragBR)&&s.saveCrop(),s.dragTL=s.dragTR=s.dragBL=s.dragBR=!1},s.getPageTopLeft=function(e){var t=e.getBoundingClientRect(),r=document.documentElement;return{left:t.left+(window.pageXOffset||r.scrollLeft||0),top:t.top+(window.pageYOffset||r.scrollTop||0)}},s.mouseMove=function(e){var t=s.getPageTopLeft(s.canvas);if(s.mouseX=e.pageX-t.left,s.mouseY=e.pageY-t.top,s.dragTL)s.rect.w+=s.rect.startX-s.mouseX,s.rect.h+=s.rect.startY-s.mouseY,s.rect.startX=s.mouseX,s.rect.startY=s.mouseY;else if(s.dragTR)s.rect.w=Math.abs(s.rect.startX-s.mouseX),s.rect.h+=s.rect.startY-s.mouseY,s.rect.startY=s.mouseY;else if(s.dragBL)s.rect.w+=s.rect.startX-s.mouseX,s.rect.h=Math.abs(s.rect.startY-s.mouseY),s.rect.startX=s.mouseX;else if(s.dragBR){if(s.mouseX+50<=s.rect.startX||s.mouseY+50<s.rect.startY)return!1;s.rect.w=Math.abs(s.rect.startX-s.mouseX),s.rect.h=Math.abs(s.rect.startY-s.mouseY)}s.ctx.clearRect(0,0,s.canvas.width,s.canvas.height),s.draw()},s.draw=function(){s.rect.h<10?s.rect.h=10:s.rect.w<10&&(s.rect.w=10),s.ctx.rect(s.rect.startX,s.rect.startY,s.rect.w,s.rect.h),s.ctx.lineWidth=1,s.ctx.strokeStyle="#cccccc",s.ctx.stroke(),s.drawShadedBoxes(),s.drawHandles()},s.drawShadedBoxes=function(){s.ctx.globalAlpha=.6,s.ctx.fillStyle="#000",s.ctx.fillRect(0,0,s.rect.startX,s.canvas.height),s.ctx.fillRect(s.rect.startX+s.rect.w,0,s.canvas.width-s.rect.startX,s.canvas.height),s.ctx.fillRect(s.rect.startX,s.rect.startY+s.rect.h,s.rect.w,s.canvas.height),s.ctx.fillRect(s.rect.startX,0,s.rect.w,s.rect.startY)},s.drawHandles=function(){s.drawCircle(s.rect.startX,s.rect.startY,s.closeEnough),s.drawCircle(s.rect.startX+s.rect.w,s.rect.startY,s.closeEnough),s.drawCircle(s.rect.startX+s.rect.w,s.rect.startY+s.rect.h,s.closeEnough),s.drawCircle(s.rect.startX,s.rect.startY+s.rect.h,s.closeEnough)},s.drawCircle=function(e,t){s.ctx.fillStyle="#4cae4c",s.ctx.beginPath(),s.ctx.fillRect(e-s.closeEnough/2,t-s.closeEnough/2,s.closeEnough,s.closeEnough)}}]),e.directive("cropular",function(){return{restrict:"E",scope:{imageUrl:"=",cropObject:"=",enableCrop:"="},templateUrl:"template.html",controller:"CropularController"}})}(),angular.module("cropular").run(["$templateCache",function(e){e.put("template.html",'<div class="row"><div class="col-md-12"><img id="attachment-image" ng-bind="imageUrl" style="z-index:0;" ng-src="{{imageUrl}}" ng-show="!enableCrop" class="img-responsive"><canvas id="canvas" ng-show="enableCrop" style="background-image: url(\'{{imageUrl}}\'); background-size: contain"></canvas></div></div>')}]);